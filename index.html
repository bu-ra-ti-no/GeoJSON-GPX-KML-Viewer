<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoJSON-GPX-KML Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/ol@v10.6.0/dist/ol.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v10.6.0/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol-layerswitcher@4.1.2/dist/ol-layerswitcher.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol-layerswitcher@4.1.2/dist/ol-layerswitcher.css">
    <style>
      body {margin: 0}
      #map {width: 100%; height: 100vh}
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
        // Creating a map
        const map = new ol.Map({
          target: 'map',
          layers: [ new ol.layer.Tile({ source: new ol.source.OSM(), title: 'OpenStreetMap' }) ],
          view: new ol.View({
            center: ol.proj.fromLonLat([37.6173, 55.7558]), // Coordinates of the center (Moscow)
            zoom: 10
          })
        });
        map.addControl(new ol.control.FullScreen());
        map.addControl(new ol.control.LayerSwitcher());
        map.cc = -1;
        map.newColor = function() {
          if (++this.cc < 5) {
            return ['#FF0000', '#FFFF00', '#0000FF', '#FF00FF', '#00FF00'][this.cc]
          }
          const letters = '0123456789ABCDEF';
          let color = '#';
          for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
          }
          return color; 
        };
        map.appendAlpha = function(color, alpha) {
          const r = parseInt(color.slice(1, 3), 16),
            g = parseInt(color.slice(3, 5), 16),
            b = parseInt(color.slice(5, 7), 16);
          return `rgb(${r}, ${g}, ${b}, ${alpha})`;
        };

        // Event handler for loading a file
        document.addEventListener('dragover', (event) => { event.preventDefault() });
        document.addEventListener('drop', (event) => {
          event.preventDefault();
          let zoomed = false;
          for (const file of event.dataTransfer.files) {
            const ext = file.name.slice(-3);
            if (['son', 'gpx', 'kml'].includes(ext)) {
              const reader = new FileReader();
              reader.readAsText(file);
              reader.onload = function(e) {
                const parser = ext === 'gpx'
                  ? new ol.format.GPX()
                  : ext === 'kml'
                    ? new ol.format.KML({ extractStyles: false, extractAttributes: true })
                    : new ol.format.GeoJSON();
                const features = parser.readFeatures(e.target.result, {
                  dataProjection: 'EPSG:4326',   // WGS-84
                  featureProjection: 'EPSG:3857' // Pseudo-Mercator
                });
                if (features.length === 0) return;

                const color = map.newColor();
                const style = new ol.style.Style({
                  image: new ol.style.Circle({
                    radius: 5,
                    fill: new ol.style.Fill({ color: color }),
                  }),
                  stroke: new ol.style.Stroke({
                    color: color,
                    width: 2
                  }),
                  fill: new ol.style.Fill({ color: map.appendAlpha(color, '15%') }),
                  text: new ol.style.Text({
                    font: '12px sans-serif',
                    textAlign: 'left',
                    fill: new ol.style.Fill({ color: 'black' }),
                    stroke: new ol.style.Stroke({
                      color: 'white',
                      width: 2
                    }),
                    offsetX: 10
                  })
                });

                const vectorLayer = new ol.layer.Vector({
                  title: file.name,
                  source: new ol.source.Vector({ features: features }),
                  style: function(feature) {
                    style.getText().setText(feature.get('name'));
                    return style;
                  }
                });

                map.addLayer(vectorLayer);

                // Checking the visibility of objects in the current zoom level
                const fileExtent = vectorLayer.getSource().getExtent();
                const mapExtent = map.getView().calculateExtent(map.getSize());
                if (ol.extent.intersects(mapExtent, fileExtent)) {
                  zoomed = true;
                  map.render();
                } else if (!zoomed) {
                  zoomed = true;
                  map.getView().fit(fileExtent, { duration: 2000 });
                }
              };
            }
          }
        });
    </script>
  </body>
</html>
